<div class="face-analysis-container">
  <div class="analysis-header">
    <h2>ğŸ¯ Analyse de Votre Visage</h2>
    <p>Obtenez des recommandations personnalisÃ©es basÃ©es sur votre type de peau</p>
    
    <!-- Indicateur de chargement des modÃ¨les -->
    @if (!modelsLoaded()) {
      <div class="loading-models">
        <div class="spinner"></div>
        <p>Chargement des modÃ¨les IA...</p>
      </div>
    }
  </div>

  <!-- Ã‰tape 1: Demande de permission -->
  @if (currentStep() === 'permission' && modelsLoaded()) {
    <div class="permission-step">
      <div class="camera-icon">ğŸ“·</div>
      <h3>AccÃ¨s Ã  la CamÃ©ra</h3>
      <p>Nous avons besoin d'accÃ©der Ã  votre camÃ©ra pour analyser votre visage et vous proposer les meilleurs produits.</p>
      <button class="start-btn" (click)="startCamera()">
        Commencer l'Analyse
      </button>
    </div>
  }

  <!-- Ã‰tape 2: AperÃ§u vidÃ©o avec dÃ©tection -->
  @if (currentStep() === 'camera') {
    <div class="camera-step">
      <div class="video-container">
        <video #videoElement autoplay playsinline [class.mirror]="true"></video>
        <div class="face-guide">
          <div class="face-oval" [class.detected]="faceDetected()"></div>
        </div>
        
        <!-- Indicateur de dÃ©tection -->
        <div class="detection-status" [class.detected]="faceDetected()">
          @if (faceDetected()) {
            <span class="status-icon">âœ…</span>
            <span>Visage dÃ©tectÃ©</span>
          } @else {
            <span class="status-icon">ğŸ”</span>
            <span>Recherche de visage...</span>
          }
        </div>
      </div>
      
      <div class="camera-controls">
        <button class="capture-btn" 
                (click)="capturePhoto()" 
                [disabled]="!cameraReady() || !faceDetected()">
          ğŸ“¸ Capturer Photo
        </button>
        <button class="stop-btn" (click)="stopCamera()">
          ArrÃªter
        </button>
      </div>
      
      <div class="instructions">
        <p>ğŸ‘¤ Positionnez votre visage dans l'ovale</p>
        <p>ğŸ’¡ Assurez-vous d'avoir un bon Ã©clairage</p>
        <p>ğŸ¯ Le bouton se dÃ©bloquera quand un visage sera dÃ©tectÃ©</p>
      </div>
    </div>
  }

  <!-- Ã‰tape 3: Photo capturÃ©e -->
  @if (currentStep() === 'captured') {
    <div class="captured-step">
      <div class="photo-preview">
        <img [src]="getCapturedImage()" alt="Photo capturÃ©e" class="captured-photo">
      </div>
      
      <div class="photo-actions">
        <button class="retry-btn" (click)="retakePhoto()">
          ğŸ”„ Reprendre Photo
        </button>
        <button class="analyze-btn" (click)="analyzePhoto()">
          ğŸ¯ Analyser cette Photo
        </button>
      </div>
    </div>
  }

  <!-- Ã‰tape 4: Analyse en cours -->
  @if (currentStep() === 'analyzing') {
    <div class="analyzing-step">
      <div class="analysis-animation">
        <div class="brain-icon">ğŸ§ </div>
        <div class="scanning-line"></div>
      </div>
      <h3>Analyse Faciale en cours...</h3>
      <p>Notre IA analyse votre visage pour vous proposer les meilleurs produits</p>
      <div class="progress-steps">
        <div class="step active">ğŸ” DÃ©tection du visage</div>
        <div class="step active">ğŸ“Š Analyse des caractÃ©ristiques</div>
        <div class="step">ğŸ¤– Analyse IA avancÃ©e</div>
      </div>
    </div>
  }

  <!-- Ã‰tape 5: Analyse IA AvancÃ©e -->
  @if (currentStep() === 'ai-analyzing') {
    <div class="ai-analyzing-step">
      <div class="ai-animation">
        <div class="ai-brain">ğŸ¤–</div>
        <div class="ai-particles">
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
        </div>
      </div>
      <h3>ğŸš€ Analyse IA AvancÃ©e avec DeepSeek</h3>
      <p>Intelligence artificielle gÃ©nÃ©rative en action pour des recommandations ultra-prÃ©cises</p>
      <div class="ai-progress-steps">
        <div class="step completed">âœ… DÃ©tection du visage</div>
        <div class="step completed">âœ… Analyse des caractÃ©ristiques</div>
        <div class="step active pulse">ğŸ¤– Analyse DeepSeek AI</div>
        <div class="step">ğŸ’¡ GÃ©nÃ©ration des recommandations</div>
      </div>
      <div class="ai-loading-text">
        <span class="typing-text">Analyse des proportions faciales...</span>
      </div>
    </div>
  }

  <!-- Ã‰tape 5: RÃ©sultats dÃ©taillÃ©s avec vrais produits -->
  @if (currentStep() === 'results' && analysisResults()) {
    <div class="results-step">
      <h3>âœ¨ Analyse TerminÃ©e</h3>
      
      <div class="analysis-summary">
        <div class="result-card">
          <h4>ğŸ“Š Vos CaractÃ©ristiques</h4>
          <div class="characteristic">
            <span class="label">Ã‚ge estimÃ©:</span>
            <span class="value">{{ analysisResults().estimatedAge }}</span>
          </div>
          <div class="characteristic">
            <span class="label">Type de peau:</span>
            <span class="value">{{ analysisResults().skinType }}</span>
          </div>
          <div class="characteristic">
            <span class="label">Forme du visage:</span>
            <span class="value">{{ analysisResults().faceShape }}</span>
          </div>
          <div class="characteristic">
            <span class="label">Confiance IA:</span>
            <span class="value">{{ (analysisResults().confidence * 100).toFixed(1) }}%</span>
          </div>
        </div>

        <div class="tips-card">
          <h4>ğŸ’¡ Conseils PersonnalisÃ©s</h4>
          <ul class="tips-list">
            @for (tip of personalizedTips(); track tip) {
              <li class="tip-item">{{ tip }}</li>
            }
          </ul>
        </div>
      </div>

      <!-- ğŸ›’ NOUVELLE SECTION : Produits RecommandÃ©s -->
      @if (productRecommendations().length > 0) {
        <div class="products-section">
          <h4>ğŸ›ï¸ Produits RecommandÃ©s pour Vous</h4>
          <div class="products-grid">
            @for (recommendation of productRecommendations(); track recommendation.product.id) {
              <div class="product-recommendation">
                <div class="product-card">
                  <div class="product-image">
                    @if (recommendation.product.images[0]?.url) {
                      <img [src]="recommendation.product.images[0].url" 
                           [alt]="recommendation.product.images[0].alt">
                    } @else {
                      <div class="placeholder-image">ğŸ“¦</div>
                    }
                  </div>
                  
                  <div class="product-info">
                    <h5 class="product-title">{{ recommendation.product.title }}</h5>
                    <p class="recommendation-reason">{{ recommendation.reason }}</p>
                    <div class="product-price">
                      {{ recommendation.product.price.toLocaleString('fr-FR') }} {{ recommendation.product.currency }}
                    </div>
                    
                    <div class="product-actions">
                      <button class="add-to-cart-btn" (click)="addToCart(recommendation)">
                        ğŸ›’ Ajouter au panier
                      </button>
                      <a class="view-details-btn" [routerLink]="['/product', recommendation.product.id]">
                        ğŸ‘ï¸ Voir dÃ©tails
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <div class="results-actions">
        <button class="new-analysis-btn" (click)="resetAnalysis()">
          ğŸ”„ Nouvelle Analyse
        </button>
        <button class="shop-btn" routerLink="/products">
          ğŸ›’ Voir Tous les Produits
        </button>
      </div>
    </div>
  }

  <!-- Messages d'erreur -->
  @if (errorMessage()) {
    <div class="error-message">
      âš ï¸ {{ errorMessage() }}
    </div>
  }
</div>